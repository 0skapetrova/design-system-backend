# Users API contract

## 1. Описание

## 2. Модели (UserPublic)
### 2.1 UserPublic
UserPublic — это представление пользователя, которое фронт может безопасно получить, хранить и использовать в UI и своей логике, без доступа к внутренним деталям.
Модель содержит следующие поля: id, username, phone, display_name, avatar_url, created_at.

## 3. Регистрация и авторизация (общий флоу)
### 3.1 
Пользователь начинает регистрацию с ввода номера телефона. Система отправляет SMS-код и проверяет, не существует ли уже аккаунт с этим номером. После успешного подтверждения телефона пользователь заполняет данные учётной записи (уникальный username и пароль). После создания аккаунта backend возвращает информацию о пользователе, и клиент может перейти к рабочему состоянию приложения.

### 3.2 Правила валидации
Ниже описаны обязательные серверные правила валидации полей, которые backend всегда применяет при регистрации пользователя.

`username`
Уникален.
Сравнение всегда регистронезависимое (все значения приводятся к lower-case).

`phone`
Уникален.
Сравнение выполняется по нормализованному значению (только цифры).

`display_name`
Может быть пустым (null).
Максимум 50 символов.
Не участвует в уникальности.

`avatar_url`
Может быть пустым (null).
Должен быть валидным URL, если указан.

Пароль должен соответствовать минимальным требованиям безопасности - минимальная длина: 8 символов, хотя бы 1 буква, хотя бы 1 заглавная буква. Разрешённые символы: латинские буквы, цифры, спецсимволы.

### 3.3 Ошибки валидации
Описание ошибок валидации является частью API-протокола, ошибки должны быть обработаны UI, сервер будет их возвращать в стандартизированном виде.

#### PHONE_INVALID
Возникает, когда номер телефона не проходит серверную проверку формата

#### PHONE_ALREADY_REGISTERED
Номер телефона уже используется другим аккаунтом, регистрация невозможна.

#### TOO_MANY_REQUESTS
Повторный запрос SMS-кода отправлен слишком рано; действует ограничение по времени.

#### CODE_INVALID
Введённый код неверный.

#### CODE_EXPIRED
Код просрочен и требует повторной отправки.

#### USERNAME_TAKEN
Такой username уже существует.

#### PASSWORD_WEAK
Пароль не соответствует минимальным требованиям безопасности.

#### TOO_MANY_ATTEMPTS
Количество доступных попыток ввода кода исчерпано; дальнейшая проверка невозможна без запроса нового кода.

#### PHONE_BLOCKED
Номер телефона временно заблокирован за превышение лимитов или подозрительную активность.

## 4. Эндпойнты
### 4.1 Авторизация 
#### 4.1.1 Запрос кода
POST /api/auth/request-code
Фронт вызывает этот эндпойнт, чтобы отправить sms код, в успешном ответе он получает информацию, что запрос на отправку кода принят, сколько секунд ждать до следующего запроса и сколько попыток запросить код ещё осталось.
Фронт отправляет в теле запроса один параметр phone, к нему применяются правила валидации из раздела 3.2, других полей в звпросе нет.
Успешный ответ означает, что запрос на отправку кода принят и содержит два поля: сколько секунд ждать до следующего запроса и сколько попыток запросить код осталось. Дополнительных данных в успешном ответе нет.

Возможные ошибки: PHONE_INVALID, PHONE_ALREADY_REGISTERED, TOO_MANY_REQUESTS, PHONE_BLOCKED.

#### 4.1.2 Верификация кода
POST /api/auth/verify-code
Фронт вызывает этот эндпойнт, чтобы проверить введённый SMS-код и завершить этап подтверждения телефона (без создания пользователя). При успешной верификации сервер отвечает статусом 204 без тела, а сам факт этого статуса означает, что телефон подтверждён и фронт может переходить к следующему шагу регистрации (вводу username и пароля).
Фронт в теле запроса передаёт два поля: phone и code, для phone действуют правила валидации из раздела 3.2, а для code важна только корректность формата и актуальность кода (подробная логика проверки описана отдельно, внутри бэкенда).

Возможные ошибки: PHONE_INVALID, CODE_INVALID, CODE_EXPIRED, TOO_MANY_ATTEMPTS, PHONE_BLOCKED.

## 5. Примеры (success + error)
### 5.1 Request-code — успешный ответ
```json
{
  "Status": "200 OK",
  "Body":{
    "attempts_left": 4,
    "time_to_new_code_left": 30
  },
}
```
### 5.2 Request-code — ошибка
```json
{
  "error": "PHONE_INVALID",
  "message": "Номер телефона не проходит серверную проверку формата",
  "details": "phone должен содержать только цифры"
}
```
### 5.3 Verify-code — ошибка
```json
{
  "error": "CODE_INVALID",
  "message": "Введённый код неверный",
  "details": "Отправьте новый запрос"
}
```